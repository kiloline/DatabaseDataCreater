# DatabaseDataCreater：一个用于从create table的SQL当中自动生成自定义的insert数据的工具
### 今后将不再提供Java8的测试和支持，全面转移到Java11直到下一个Java LTS为止
### 简介
本程序的作用是根据给定的建立数据库表的SQL（create语句），自动的生成给定行数的数据，这些数据可以以insert语句的方式产生，
也可以是逗号隔开的csv格式以便通过数据库外部表或load工具来利用。支持通过JDBC直接导入数据。支持生成json字符串。支持--、//、/**/三种注释方式。
## 最简化使用方法
该方法可以不需要config.properties的配置文件。  
1. 下载 https://github.com/kppomzh/DatabaseDataCreater/releases/download/V2.0.0/DBDF-2.0.0.zip  
2. 解压  
3. 双击DBDF-2.0.0.exe  
5. 按照提示输入create命令和输出条数  
6. 当前文件夹下就可以找到和表名一致的.sql文件，里面是相应条数的insert数据  
7. 复制粘贴运行三连  

## 当前版本性能测试
### 本地写入测试
#### 硬件环境
PC1:
CPU:AMD Ryzen R5 3600X 4.0~4.025Ghz  
Memory:32G DDR4 3200Mhz  

PC2:
CPU:Intel i5-10400 4.0Ghz  
Memory:16G DDR4 2666Mhz  

SSD:Toshiba TR150 256G  

#### 软件环境以及测试条件
OS:Fedora 32  
Kernel:5.6.10  
Java:OpenJDK 11.0.9/16.0.1  
测试条件:  
1. 6线程  
2. 异步写入  
3. 默认值比例0.9  
4. 禁止SQL优化  
5. 写入方式为sql  
6. 生成条数100000000  
7. 多联输出开启  
8. 每次输出10000条

本次测试调大了Linux的缓存使用量，并且在回写上的策略更加消极。PC1基本可以做到所有数据都内存中写入，几乎完全避免了磁盘IO延迟的影响。  
但是在Java11的测试中仍然轻微的落后于Intel。  
当然Java测试很难稳定，我在Java11上测试了三次取平均值，Java14上仅有一次测试。

#### 测试结果
暂时没有对比测试

### 性能变化
无

## 程序参数详解
-h:显示帮助。  
-v:显示当前工具版本。   
-f:指定输入的SQL文件位置，如果不指定的话将会询问对什么样的create创建数据。  
-n:指定输出的数据条数，如果不指定的话将会询问具体的输出条数。  
-o:指定保存输出数据的文件夹位置。  
-t:指定线程数量，当这个值大于1的时候会采用多线程的方式写入多个文件中。  
-i:指定生成数据的载入方式，有"jdbc"、"sql"、"csv"、"json"、"mongo"五种方式。  
-O:允许SQL优化，将长度上限特别大的字段随机缩短长度，可以加快生成速度，或者模拟现实当中的字段长度。  
-L:允许多联输出数据，例如一条insert内填充多行数据，默认一次生成10000行，生成行数暂时只能通过配置文件修改，该方法对Json、csv等方式无效。
-N:允许数值出现负值。  

## 支持的SQL数据类型
1. 整形数值型  
integer  
int  

2. 浮点数值型  
number  
numeric  
float  
double  
decimal  

3. 字符型  
varchar  
varchar2  
char  
nvarchar  
nvarchar2  
string  
text  

4. 日期型  
date  
timestamp  

5. 布尔型  
boolean  
bool

## 标准SQL中存在的关键字作用的说明
### 1.unique/唯一约束
该关键字将会使该字段中所有数据均唯一。使用的注意事项见最下。
### 2.default/默认值
在一个字段后面加上default关键字，并且写明default的内容，程序就会将这个值做为这个字段的默认填充。  
填充的比例由配置文件中的“defaultProportion”设置项决定。  
默认值可以和其他任何数据生成方式兼容，两者比例大致稳定在“defaultProportion”附近。
### 3.primary key/主键
主键约束提供类似于序列的生成方式，每次从1开始到生成条数处结束，不支持任何自定义的字符串格式；同时，只支持字段类型为数值型或字符型。
以往的主键采用的是和唯一约束类似的生成方式，所以性能很成问题，但是从1.4.1开始已经不成为性能瓶颈。
### 4.foreign key references/外键


## 自定义数据格式，按照预计生成数据的方法
注意：字段类型会覆盖先前指定的类型，所以务必保证对应字段的数据类型是长度足够的字符串形式。

### 本程序默认的数据格式实现
#### 1.stringtype
可以在每个字段的后面加上stringtype关键字来指定当前字段的数据格式，包括ch_idcard（中国身份证号）、telephone（中国手机号）、email（电子邮件）、ch_word（汉字字符串）、a/b/c/d/e_ip（五种IP地址）、warp_latitude（经纬度）等几种数据。
#### 2.numberarea  
1.4.3中的一项重要改进是numberarea已经支持小数范围了，这项特性已经被反向移植到1.4.x的版本中，但是在旧版本中此特性可能存在一定的bug。  
可以在每个字段的后面加上numberarea关键来指定当前字段的数值范围，该方式仅对标记为数值型的字段适用。  
例如numberarea 5~10，就会生成范围在{5,6,7,8,9,10}之内的任意数，根据字段类型也可以是浮点数。
#### 3.unmake
如果在一个字段的后面加上unmake，在程序中会认为这个字段不能接受随机数据，或者字段有默认值所以不想填充；此时将会跳过该字段，继续生成下一个字段。  
如果使用SQL或者JDBC的方式进行填充，那么不需要担心缺少字段可能的影响，因为程序会在insert子句中自动的添加上其他所有待生成字段的名称。  
但是如果计划采用csv方式，那就需要谨慎的查找对应数据库的行为，确定这种方式会造成什么影响。  
此特性由于csv不安全，此前（2020年之前）一直都是做为不开放的特性使用。  

### 如何自定义数据格式
#### 1.inline方式  
如果某个字段有多个确定值，只需要从中选择一个的话，可以用inline方式。多个值放在字段后面的一个大括号中，用逗号分开。  
需要注意的是这种方法不限制数据类型，但是字符型和日期型需要添加单引号，数值型不需要添加引号。  
例如"name varchar(10) {"aaa","bbb"}"，这样的话那么这个字段里的值就只有aaa和bbb。  

#### 2.regulartype
即通过正则表达式生成规定格式的字符串，关键字是regulartype。  
因为标准的正则表达式当中，很多元字符对于生成字符串是没有用的，所以在这里的元字符是有所简化的版本。   
##### 元字符定义：  
{n}：匹配前面的子表达式确定次数。  
{n,}：匹配前面的子表达式至少n次，至多(n+1)5次。  
{n,m}：匹配前面的子表达式至少n次，至多m次，n<=m。在逗号和两个数之间不能有空格。  
\*：匹配前面的子表达式零次或多次，等价于{0,}。  
+：匹配前面的子表达式一次或多次，等价于 {1,}。  
?：匹配前面的子表达式零次或一次，等价于{0,1}。  
x|y：匹配x子表达式或者y子表达式，选择其一来生成字符串。  
[xyz]，字符集合，匹配中括号所包含的任意一个字符。  
[a-z]，字符范围。匹配指定范围内的任意字符。  
\d：匹配一个数字。   
\s：匹配一个空格。   
\S：匹配所有非空白字符。（不全）   
\w：匹配范围包含大小写字母、数字、下划线。   
\W：匹配非字母数字下划线。   
\num：匹配一个10^6以内的正整数。   
\z：匹配一个Unicode汉字，但不保证你认识。   
()：子表达式。  
##### 转义字符定义：  
在正常的正则表达式中，包含以下转义字符。  
\n、\r、\t、\b、\f、\0、\\\\、\\( and \\)、\\[ and \\]、\\{ and \\}、\\' and \\"、\\*、\\+、\\?  
另外，针对中括号中的转义，只将'\\-'处理成'-'。  

最后在正则表达式结束的时候一定要用'$'作为结束标记。  

#### 3.stringtype for free  
本质上仍然是正则表达式，使用properties配置文件来对应名称和正则表达式。配置文件位置在config.properties文件的CustomStringtypeConf选项中进行指定，两个文件之间用';'进行分隔。  

## 配置文件config.properties的参数设置
### 数据库连接部分参数
DBsoftware:确定数据库软件，例如Oracle或者MySQL  
IP:目标数据库的地址  
port:目标数据库的端口，如果采用数据库的默认端口的话可以留空，运行的时候会自动补全  
user:目标数据库的登陆用户名  
password:目标数据库的登陆密码，可以留空  
database:目标数据库名称  

### 数据导入
toDB:传递给DB的方式，目前允许jdbc（通过jdbc传SQL），sql（写到对应的表名称的sql文件里），csv（通过写入类似外部表的文件载入），json（json字符串文件）~~，mongo（MongoDB）~~。    
baseFileDir:数据文件写入位置，当toDB为jdbc的时候参数失效。    
canbeNegative:是否允许数值型数据出现负数，当指定输入范围时失效。   
dbCharSet:指定输出的字符串以什么字符集写入指定位置；理论上，Java支持很多种字符集的编解码，但是在此不可能列出所有的编码方案来，仅列出常见的7种字符集放在配置文件中供参考。该值可以留空，留空后会选择当前环境中的默认字符集填入；该值区分大小写。 

### 性能参数
Optimal:SQL优化，（伪）随机缩短字符串长度，避免超长字符串的变量生成导致长时间卡顿。    
TOTAL_THREADS:总线程数量，当asynchronous为true的时候整个任务将会被分成和线程数量同等的多个文件。  
defaultProportion:取值区间0~1，default值在整个字段中占用的默认比例，如果有使用default值的字段，加大该参数会适当的提高程序的性能，但是一定要按照实际的业务需求制定该参数的允许上限。  
WriterEngine:输出结果使用的引擎，目前有三种：default、apache、screenout。default与apache性能上差不多，不同条件下略有差异；另外如果需要
验证create语句中各选项的写法是否有问题，想要输出到命令行中的话，请使用screenout参数，不过使用前请先仔细看好生成条数。  
longerInsert:长insert，将多条数据整合在一个insert中。针对JDBC方式会加快插入速度。  
longerInsertNumber:长insert一次生成的条数，默认是10000。  

## 已经支持通过JDBC直接发送数据的数据库
Oracle  
MySQL（至少兼容MariaDB、TiDB、SequoiaDB三种）  
SQLserver  
DB2  
PostgreSQL  
SQLite  
H2  
~~MongoDB~~ **由于MongoDB最近的Java驱动莫名其妙的删掉了和JDBC标准有关的Driver实现类，所以现在没办法支持发送Mongo的json字符串过去。**  
Presto  
~~Hive~~ **Hive的JDBC驱动不支持Java8以上的JDK。** 

## 注意事项
1. 关于数据库连接选项的设置这里暂时不提供，请用配置文件实现。  
2. 关于写文件引擎选项的设置这里暂时不提供，请用配置文件实现。   
3. 目前文件路径不能带空格，因为暂时没加对于单双引号的参数识别。  
4. 如果采用异步写的方式，unique约束在多个文件之间失效。如果建立基于全局的约束会导致性能严重下降，所以不支持全局唯一约束。  
5. 过大的表尽量不要使用unique约束，会导致：1.异常的内存占用；2.对数函数级别的性能下降（减函数）。  
6. 本工具不支持过分复杂的create，带有索引或者约束的SQL请将这些限制直接的写在对应字段后方，不要写在create括号的后面，否则会被掠过。    
